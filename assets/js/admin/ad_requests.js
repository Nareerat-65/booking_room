$(function () {
    $('#bookingsTable').DataTable({
        language: {
            search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
            lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤",
            info: "‡πÅ‡∏™‡∏î‡∏á _START_‚Äì_END_ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
            zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
            paginate: {
                first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
                last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
                next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
                previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"
            }
        },
        pageLength: 10,
        order: []
    });

    // ===== logic ‡πÄ‡∏î‡∏¥‡∏° =====
    let selectedId = null;
    let currentDetailId = null;

    function openDetailModalFromRow($tr) {
        const status = ($tr.data('status') || '').toString();
        const reason = ($tr.data('reason') || '').toString();

        const id = $tr.data('id');
        currentDetailId = id;

        const name = $tr.find('td').eq(1).text().trim();
        const inDate = $tr.find('td').eq(9).text().trim();
        const outDate = $tr.find('td').eq(10).text().trim();
        const ppl = $tr.find('td').eq(11).text().trim();

        const $header = $('#detailHeader');
        $header.removeClass('bg-success bg-danger bg-secondary');

        let title = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠';
        if (status === 'approved') {
            $header.addClass('bg-success');
            title = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)';
        } else if (status === 'rejected') {
            $header.addClass('bg-danger');
            title = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)';
        } else {
            $header.addClass('bg-secondary');
        }
        $('#detailTitle').text(title);

        let html = `
                <div class="mb-2"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> ${name}</div>
                <div class="mb-2"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å:</b> ${inDate}</div>
                <div class="mb-2"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å:</b> ${outDate}</div>
                <div class="mb-2"><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô:</b> ${ppl}</div>
            `;
        if (status === 'rejected') {
            html += `<div class="alert alert-danger mt-3"><b>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</b> ${reason || '‚Äî'}</div>`;
        }

        $('#detailBody').html(html);

        const $btnDelete = $('#btnDeleteBooking');
        const $btnEdit = $('#btnEditBooking');

        if (status === 'approved') {
            $btnDelete.removeClass('d-none');
            $btnEdit.removeClass('d-none');
        } else {
            $btnDelete.addClass('d-none');
            $btnEdit.addClass('d-none');
        }

        $('#detailsModal').modal('show');
    }

    function updateStatus(id, status, reason = null) {
        // üî∏ Show loading indicator
        SA.loading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');

        $.post('ad_updateStatus.php', {
            id,
            status,
            reason
        }, function (res) {
            if (res === 'success') {
                const $tr = $(`#bookingsTable tr[data-id="${id}"]`);
                const $statusCell = $tr.find('td').eq(12);

                if (status === 'approved') {
                    $statusCell.html('<span class="badge bg-success">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>');
                } else if (status === 'rejected') {
                    $statusCell.html('<span class="badge bg-danger">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>');
                } else {
                    $statusCell.html('<span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>');
                }

                $tr.attr('data-status', status);
                if (reason !== null) $tr.attr('data-reason', reason);

                const detailBtn = `
                    <button class="btn btn-outline-secondary btn-sm btn-detail" data-id="${id}">
                        <i class="fas fa-info-circle"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                `;
                $tr.find('td').last().html(detailBtn);

                // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πà‡∏≠‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ
                openDetailModalFromRow($tr);

                // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                SA.success((status === 'approved') ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', undefined, undefined, {
                    timer: 1500,
                    showConfirmButton: false
                });

            } else if (res === 'no_rooms') {
                SA.warning('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ', undefined, undefined, {
                    html: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å'
                });

            } else {
                SA.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ');
            }
        }).fail(function () {
            SA.error('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }).always(function () {
            // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î)
            // ‡∏ñ‡πâ‡∏≤ SA.success ‡∏°‡∏µ timer ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á close ‡πÄ‡∏û‡∏¥‡πà‡∏°
        });
    }

    // ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    $('#bookingsTable').on('click', '.btn-approve', function () {
        const $tr = $(this).closest('tr');
        const id = $tr.data('id');
        updateStatus(id, 'approved');
    });

    // ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
    $('#bookingsTable').on('click', '.btn-reject', function () {
        selectedId = $(this).closest('tr').data('id');
        $('#rejectModal').modal('show');
    });

    $('#rejectForm').on('submit', function (e) {
        e.preventDefault();
        const reason = $('#reason').val().trim();
        if (!reason) {
            SA.warning('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
            return;
        }

        $('#rejectModal').modal('hide');

        updateStatus(selectedId, 'rejected', reason);
        $('#reason').val('');
    });

    // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    $('#bookingsTable').on('click', '.btn-detail', function () {
        const $tr = $(this).closest('tr');
        openDetailModalFromRow($tr);
    });

    // ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô modal
    $('#btnDeleteBooking').on('click', function () {
        if (!currentDetailId) return;

        SA.confirm(
            '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á?',
            '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ',
            '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
            '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            (isConfirmed) => {
                if (!isConfirmed) return;

                SA.loading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');

                $.post('ad_delete_booking.php', { id: currentDetailId }, function (res) {
                    res = (res || '').toString().trim();

                    if (res === 'success') {
                        // ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        $(`#bookingsTable tr[data-id="${currentDetailId}"]`).remove();

                        $('#detailsModal').modal('hide');

                        SA.success('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', undefined, undefined, {
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        SA.error('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    }
                }).fail(function () {
                    SA.error('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                });
            },
            {
                confirmButtonColor: '#d33'
            }
        );
    });

    // ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô modal
    $('#btnEditBooking').on('click', function () {
        if (!currentDetailId) return;

        // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î: ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        window.location.href = 'ad_edit_booking.php?id=' + currentDetailId;
    });

});